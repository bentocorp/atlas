<html>
  <head>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js'></script>
    <script src='ext/socket.io-client.js'></script>
    <script type='text/javascript'>

      // Make sure browser supports WebSocket API. Is this still needed if we
      // include socket.io?
      if ('WebSocket' in window) {
        
      } else { 
        console.log('WebSocket not supported.')
      }
      var soc;
      io.timeout = 5000; // 5 seconds
      
      function println(msg) {
        $('#client').append(msg+'\n');
      }
      
      function switchControls(id) {
        $('.ctrl').hide();
        $('#ctrl-'+id).show();
        switch (id) {
       	  case 'a': $('body').css({'background-color': 'white'}); break;
          case 'd': $('body').css({'background-color': 'orange'}); break;
          case 'c': $('body').css({'background-color': 'green'}); break;
        }
      }
      var token;


      function connect() {
        // Tries to upgrade http:// to ws:// and falls back on long polling if
        // unsuccessful.
        port = $('#node-port').val();
        var id = $('#client-id').val();
          if (soc == null) {
          // XXX: Subsequent calls will not create new connections unless specified. However, a new Socket
          // instance is created referencing the same underlying connection so callbacks may be invoked
          // multiple times so be careful.
          // { 'force new connection': true }
          
          var url = 'http://127.0.0.1:8080';
          //var url = 'https://node.dev.bentonow.com:8081';
          //var url = 'http://' + host + ':' + port;
          


          println("connecting to " + url);
          soc = io.connect(url, { });
          
          soc.on('connect', function () {
            println('Connection established.');
            println('Authenticating');
            

         
            var username=$('#client-id').val();
            var type=$('#client-type').val()

            soc.emit('get', '/api/authenticate?username='+username+'&password=wordpass&type='+type, function (res) {
              res = JSON.parse(res);
              if (res.code == 0) {
                println('Successfully authenticated');
                token = res.ret['token'];
                clientId = res.ret['uid'];



              } else {
                println(res['msg']);
              }
            });



          });

          soc.on("test", function (msg) {
            println(msg);
          });
          
          soc.on('reconnecting', function (n) {
            println('Attempting to reconnect (n='+n+').');
          });
           
          soc.on('reconnect', function () {
            println('Successfully reconnected.')
          });

          soc.on('disconnect', function () {
            println('I got disconnected!');
          });
          
          soc.on('push', function (msg) {
var data = JSON.parse(msg);            
println(data.body);
          })

          soc.on('stat', function (msg) {

            //println(msg);
            var res = JSON.parse(msg);
            println(res.clientId+':'+res.status);
          
          });
          
          soc.on('loc', function (e) {
            e = JSON.parse(e);
            var msg = "Location update for client " + e.clientId + ": (" + e.lat + ", " + e.lng + ")";
            println(msg);
          });

          soc.on("pong", function (e) {
            println(e);
          });
        }
 
      }
      
      //var host = '54.191.141.101'; // bento-dev-nodejs01
      var port = 8081;
      var host = 'localhost';
      var url = "http://" + host + ":" + port;
      
      function uloc(_lat, _lng) {
        /*
        var data = {
          api: '/api/uloc',
        };*/
        $.getJSON(url + '/api/uloc', {
          uid: clientId,
          lng: -122.4193735,
          lat: 37.7648199,
          'token': token,
        }).done(function (ret) {
          if (ret.code == 0) {
            println('Successfully updated loc=' + _lat + ', ' + _lng);
          } else {
            println(ret.msg);
          }
        });
      }
      
      function track(_clientId) {
        console.log(_clientId);
        $.getJSON('http://' + host + ':' + port + '/api/track', {
          uid: clientId,
          clientId: _clientId,
          'token': token,
        }).done(function (res) {
          if (res.code == 0) {
            var status = res.ret.connected ? 'online' : 'offline';
            println('Tracking ' + _clientId + '('+status+')');
          } else {
            println(res.msg);
          }
        });
      }
      
var clientId;

      function push(_target, _msg) {
        println('here');
        $.getJSON('http://' + host + ':' + port + '/api/push', {
          uid: clientId,
          to: JSON.stringify([_target]),
          subject: 'wat',
          body: _msg,
          'token': token,
        }).done(function (ret) {
          if (ret.code == 0) {
            println('Sent to ' + _target + ': ' + _msg);
          } else {
            println(ret.msg);
          }
        }); 
      }
      
      var c = null;
      var theta = 0;
      
      function move() {
        window.setInterval(function () {
          var lat = parseFloat($('#coord-x').val());
          var lng = parseFloat($('#coord-y').val());
          
          if (c == null) {
            c = [lng - 0.002, lat];
          }
          theta = theta + 0.02;
          var p = [c[0] + 0.002 * Math.cos(theta), c[1] + 0.002 * Math.sin(theta)];
          
          $('#coord-x').val(p[1]);
          $('#coord-y').val(p[0]);
          $('#uloc-button').click();
        }, 100);
      }
      
      
      var months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
      
      function _prependZeroes(n, str) {
        var remaining = n - str.length;
        if (remaining > 0) {
          var ret = '';
          for (var i = 0; i < remaining; i++) {
            ret = ret + '0';
          }
          return ret + str;
        }
        return str;
      }
      
      function submitOrder() {
        var d = new Date();
        var order = {
          date: _prependZeroes(2, d.getDate()) + '-' + months[d.getMonth()] + '-' + d.getFullYear() + ' ' + _prependZeroes(2, d.getHours()) + ':' + _prependZeroes(2, d.getMinutes()) + ':' + _prependZeroes(2, d.getSeconds()), // 01-AUG-2015 14:30:59
          name: $('#first-name').val() + ' ' + $('#last-name').val(),
          address: {
            line1: $('#line1').val(),
            line2: $('#line2').val(),
            city: $('#city').val(),
            state: $('#state').val(),
            zipCode: $('#zip-code').val(),
            country: $('#country').val(),
          },
          main: {
            label: food[$('#main').val()].label,
            name: food[$('#main').val()].name,
          },
          side1: {
            label: food[$('#side1').val()].label,
            name: food[$('#side1').val()].name,
          },
          side2: {
            label: food[$('#side2').val()].label,
            name: food[$('#side2').val()].name,
          },
          side3: {
            label: food[$('#side3').val()].label,
            name: food[$('#side3').val()].name,
          },
          side4: {
            label: food[$('#side4').val()].label,
            name: food[$('#side4').val()].name,
          },
          subtotal: $('#subtotal').val(),
          tax: $('#tax').val(),
          tip: $('#tip').val(),
          discount: $('#discount').val(),
          total: $('#total').val(),
        };
        
        $.ajax({
          url: 'http://52.11.208.197:8081/api/submit_order', // bento-dev-rolling01
          data: {
            order: JSON.stringify(order),
          },
        }).done(function (res) {
          if (res == 'OK') {
            println('Successfully submitted order.');
          } else {
            println('ERROR: ' + res);
          }
        });
      }
      
      var food = [
        { label: 'A', name: "Buddha's Delight" },
        { label: 'B', name: "General Tso's Pork" },
        { label: 'C', name: 'Hawaiian Tuna Poke' },
        { label: 'D', name: 'Hot Mango Hamachi Roll' },
        { label: 'E', name: 'Thai Red Curry Chicken' },
        { label: 'F', name: 'Chicken Sriracha Meatballs' },
        { label: 'G', name: 'Chili Cucumber Salad' },
        { label: 'H', name: 'Jasmine Rice' },
        { label: 'I', name: 'Portobello Mushroom Medley' },
        { label: 'I', name: 'Sun Roll' },
        { label: 'J', name: 'Walu Nigiri' },
      ];
      
      
      $(document).ready(function () {
        console.log('Document ready.');
        $.each($('.select-food'), function (index, v) {
          var html = '';
          for (var i = 0; i < food.length; i++) {
            html += '<option value="' + i + '"' + ((i == index) ? 'selected' : '') + '>' + food[i].name + '</option>';
          }
          v.innerHTML = html;
        });
      });
    </script>
  </head>
  
  <body style="background-color: green; font: 12pt Arial">
    <div>
      node port<input type="text" id="node-port" value="8081"/>
    </div>
    <div>
      Client ID:<input id="client-id" type="text" size="6" value="marc@bentonow.com"/>
      Type:<input id="client-type" type="text" value="driver"/>
      <input type="submit" value="Connect device." onclick="connect();"/>
    </div>
    Type:
    <select onchange="var i = this.selectedIndex; switchControls(this[i].value);">
      <option value='c'>Customer App</option>
      <option value='d'>Driver App</option>
      <option value='a'>Backend</option>
    </select>
    <div class="ctrl" id="ctrl-c">Driver:<input id="driver-id" type="text" size="6"/><input type="submit" value="Track" onclick="track($('#driver-id').val());"/></div>
    <div class="ctrl" id="ctrl-d" style="display: none;">
      lat:<input id="coord-x" type="text" size="5"/>
      lng:<input id="coord-y" type="text" size="5"/>
      <input id='uloc-button' type="submit" value="Send" onclick="uloc($('#coord-x').val(), $('#coord-y').val());"/>
      <input type='submit' value="Move" onclick="move();"/>
    </div>
    <input type='text' id='ping-msg'/><input type='submit' value='Ping' onclick="soc.emit('ping', $('#ping-msg').val());"/>
<div class="ctrl" id="ctrl-a" style="display: none;">
      Target:<input id="target-id" type="text" size="5"/>
      Msg:<input id="msg" type="text" size="15"/>
      <input type="submit" value="Send" onclick="push($('#target-id').val(), $('#msg').val());"/>







  <table style="font: 9pt Arial;">
    <tr><td colspan="8"><b>NAME</b></td></tr>
    <tr><td>First</td><td colspan="3"><input id="first-name" type="text" style="width: 100%;"/></td><td>Last</td><td colspan="3"><input id="last-name" type="text" style="width: 100%;"/></td></tr>
    <tr><td colspan="8"><b>ADDRESS</b></td></tr>
    <tr><td>Line 1</td><td colspan="7"><input id="line1" type="text" style="width: 100%;" value="2017 Mission St"/></td></tr>
    <tr><td>Line 2</td><td colspan="7"><input id="line2" type="text" style="width: 100%;"/></td></tr>
    <tr><td>City</td><td><input id="city" type="text" value="San Francisco" style="width: 90px;"/></td><td>State</td><td><input id="state" type="text" value="CA" style="width: 90px;"/></td><td>ZIP code:</td><td><input id="zip-code" type="text" value="94110" style="width: 90px;"/></td><td>Country</td><td><input id="country" type="text" value="USA" style="width: 90px;"/></td></tr>
    <tr><td colspan="8"><b>ORDER</b></td></tr>
    <tr><td>Main  </td><td colspan="7"><select class="select-food" id="main" ></select></td></tr>
    <tr><td>Side 1</td><td colspan="7"><select class="select-food" id="side1"></select></td></tr>
    <tr><td>Side 2</td><td colspan="7"><select class="select-food" id="side2"></select></td></tr>
    <tr><td>Side 3</td><td colspan="7"><select class="select-food" id="side3"></select></td></tr>
    <tr><td>Side 4</td><td colspan="7"><select class="select-food" id="side4"></select></td></tr>
    
    
    <tr><td/><td/><td/><td/><td/><td/><td>Subtotal</td><td><input id="subtotal" type="text" style="width: 90px;" value="12.00"/></td></tr>
    <tr><td/><td/><td/><td/><td/><td/><td>Discount</td><td><input id="discount" type="text" style="width: 90px;" value="-5.00"/></td></tr>
    <tr><td/><td/><td/><td/><td/><td/><td>Tax</td><td><input id="tax" type="text" style="width: 90px;" value="0.63"/></td></tr>
    <tr><td/><td/><td/><td/><td/><td/><td>Tip</td><td><input id="tip" type="text" style="width: 90px;" value="2.00"/></td></tr>
    <tr><td/><td/><td/><td/><td/><td/><td>Total</td><td><input id="total" type="text" style="width: 90px;" value="9.63"/></td></tr>
  </table>
  <input type="submit" value="Submit Order" onclick="submitOrder();"/>

</div>
    

<div><textarea id="client" rows='50' cols='50' disabled='true' style="font: 9pt Arial"></textarea></div>
  </body>
</html>

