<html>
  <head>
    <meta charset="utf-8"/>
    <title>Bento Dispatcher Tool</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src='./socket.io/node_modules/socket.io-client/socket.io.js'></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js'></script>
    <script src="https://api.mapbox.com/mapbox.js/v2.2.1/mapbox.js"></script>
<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-label/v0.2.1/leaflet.label.js'></script>
<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-label/v0.2.1/leaflet.label.css' rel='stylesheet' />
    <link href="https://api.mapbox.com/mapbox.js/v2.2.1/mapbox.css" rel="stylesheet" />
<style>
  body { margin:0; padding:0; }
</style>
</head>
  <body>
    <table style="background-color: #BFB2BB; border: 2px solid #AEA79F">
      <tr>
        <td><div style="width: 500px; height: 500px;" id='map'></div></td>
        <td><div id="side" style="width: 250px; height: 500px;"></div></td>
        <tr>
        <td colspan="2"><textarea id="console" disabled='true' style="font: 9pt Arial; width: 100%; height: 100px;"></textarea></td>
        </tr>
      </tr>
    </table>
    
    <script type="text/javascript">
    
    var markers = [];
    
    function println(msg) {
      $('#console').append(msg+'\n');
    }

    function init() {
      var host = '54.191.141.101'; // bento-dev-nodejs01
      var port = 8081;
      //var host = 'localhost';
      //var port = 8080;
      var url = 'http://' + host + ':' + port;
      var soc = io.connect(url, { query: 'clientId=admin01' });
      
      soc.on('connect', function () {
        println('Connection established.');
      });
      
      soc.on('push', function (msg) {
        console.log("Received " + msg);
        var push = JSON.parse(msg);
        if (push.subject == 'CLIENT_ONLINE') {
          var clientId = push.body;
          println('Tracking client ' + clientId);
          $.getJSON(url + '/api/track', {
            uid: 'admin01',
            clientId: clientId,
          }).done(function (ret) {
            if (ret.code == 0) {
              //println('Tracking ' + _clientId);
            } else {
              println('Failed.');
            }
          });
        } else if (push.subject == 'CLIENT_OFFLINE') {
           println(push.body + ' is now offline');
           map.removeLayer(markers[push.body]);
        }
      })

      soc.on('loc', function (e) {
        var clientId = e.clientId;
        var msg = "Location update for client " + clientId + ": (" + e.lat + ", " + e.lng + ")";
        println(msg);
        var p = [e.lat, e.lng];
        if (markers[clientId] == null) {
          markers[clientId] = L.marker(p, {
            icon: L.mapbox.marker.icon({
              'marker-symbol': 'car',
              'marker-size': 'large',
              'marker-color': randColor()
            })
          }).bindLabel(clientId);
          markers[clientId].addTo(map);
        } else {
        //  console.log('here');
          markers[clientId].setLatLng(L.latLng(e.lat, e.lng));
        }
      });
    }
    
    
      function randColor() {
        var digits = '0123456789ABCDEF'.split('');
        var color = '#';
        for (var i = 0; i < 6; i++) {
          color += digits[Math.floor(Math.random() * 16)];
        }
        return color;
      }
      
      
    
    
      L.mapbox.accessToken = "pk.eyJ1IjoiYmVudG9ub3ciLCJhIjoiNjI2ZmIwM2JkNzliMDZjYWEwYzkzOTc3YzdiYTQ2MmYifQ.LdRS3yQDx8_tWtEvY1bOjw";
      var map = L.mapbox.map('map', 'mapbox.streets');
      var address = encodeURI("2017 Mission St. San Francisco CA 94110");
      $.ajax({
        url: "https://api.mapbox.com/v4/geocode/mapbox.places/"+address+".json?access_token="+L.mapbox.accessToken,
      }).done(function (res) {
        var xy = res.features[0].center;
        var p = [xy[1], xy[0]]; // Reverse.
        map.setView(p, 16);
      });
      
      
      
      init();
    </script>
  </body>
</html>
